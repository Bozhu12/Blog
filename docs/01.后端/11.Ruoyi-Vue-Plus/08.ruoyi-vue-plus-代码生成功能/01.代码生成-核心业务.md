---
title: ruoyi-vue-plus 代码生成功能 - 核心业务
date: 2023-12-09 21:29:46
author: 柏竹
permalink: /ruoyi-vue-plus/8/core-business
categories: 
  - 后端
  - 框架
tags: 
  - ruoyi-vue-plus
  - 代码生成
---

框架代码生成功能可快速构建项目的基础文件，如：Controller、Service、Mapper 等基础架构文件。该框架是在页面进行配置生成信息，以实现快速开发，能够提高前期开发效率。

**ruoyi-vue-plus应用文档：** [https://plus-doc.dromara.org](https://plus-doc.dromara.org/#/ruoyi-vue-plus/framework/basic/code_generate) 

## 快速应用

**应用大致步骤**

1. 导入表
2. 设置配置表生成信息
3. 下载生成代码
4. 导入sql
5. copy 前后端
6. 启用...

::: warning
- 每个表必须包含有：**create_by**、**create_time**、**update_by**、**update_time** 字段
- 树表必须包含有指向指定字段(一般用id)，用于指向父级数据
:::

### 基本信息

无关键信息填写

### 字段信息

**填写信息说明**

- **物理类型** => SQL应用的类型
- **Java类型** => 对象属性类型
- **Java属性** => 对象属性名称

选定字段是否采用 插入/编辑/列表/查询 => 新增是否显示/编辑是否显示/列表是否显示/查询字段显示

- **查询方式**：选中查询后，指定SQL查询方式
- **显示类型**：在编辑/新增时，更加的方便使用
- **必填**：勾选后，插入的时候必须填写

### 生成信息

**单表**

关注 包路径/模块名

**树表**

关注 包路径/模块名/树id字段/树父id字段/树名

> 大量数据不适合使用，数据分级主要通过前端分级展示

## 核心业务

### 导入列表

根据 `information_schema` 数据库表信息查询

**获取库表基础信息 GenController#dataList()**

```java
@SaCheckPermission("tool:gen:list")
@GetMapping("/db/list")
public TableDataInfo<GenTable> dataList(GenTable genTable, PageQuery pageQuery) {
    return genTableService.selectPageDbTableList(genTable, pageQuery);
}
```

**业务层** (略过，无必要逻辑代码)

**SQL执行语句 GenTableMapper.selectPageDbTableList()** (该方法适配不同数据源应用，只需关注MySQL应用方式即可)

```xml
<select id="selectPageDbTableList" resultMap="GenTableResult">
    select table_name, table_comment, create_time, update_time
    from information_schema.tables
    where table_schema = (select database())
    AND table_name NOT LIKE 'xxl_job_%' AND table_name NOT LIKE 'gen_%'
    AND table_name NOT IN (select table_name from gen_table)
    <if test="genTable.tableName != null and genTable.tableName != ''">
        AND lower(table_name) like lower(concat('%', #{genTable.tableName}, '%'))
    </if>
    <if test="genTable.tableComment != null and genTable.tableComment != ''">
        AND lower(table_comment) like lower(concat('%', #{genTable.tableComment}, '%'))
    </if>
    order by create_time desc
</select>
```

**实际执行的SQL**

以下SQL是查询当前数据源的所有库表信息，因此需要加多层约束过滤

```sql
SELECT
	table_name,
	table_comment,
	create_time,
	update_time 
FROM
	information_schema.TABLES 
WHERE
	# 仅保留当前库的表
	table_schema = (SELECT DATABASE()) 
	# 排除不必要的表名(模糊匹配)
	AND table_name NOT LIKE 'xxl_job_%' 
	AND table_name NOT LIKE 'gen_%' 
	# 排除已经导入的表
	AND table_name NOT IN ( SELECT table_name FROM gen_table ) 
ORDER BY
	create_time DESC 
	LIMIT 10
```

### 导入生成表

当用户选中需要导入表时，接口会根据 *表名称* 进行插入 `gen_table`表 和 `gen_table_column`表

**导入表结构 GenController#importTableSave()**

```java
@SaCheckPermission("tool:gen:import")
@Log(title = "代码生成", businessType = BusinessType.IMPORT)
@PostMapping("/importTable")
public R<Void> importTableSave(String tables) {
    String[] tableNames = Convert.toStrArray(tables);
    // 查询表信息
    List<GenTable> tableList = genTableService.selectDbTableListByNames(tableNames);
    // 导入库表 gen_table , gen_table_column
    genTableService.importGenTable(tableList);
    return R.ok();
}
```

**导入核心业务 GenTableServiceImpl#importGenTable()**

```java {10,20}
@Transactional(rollbackFor = Exception.class)
@Override
public void importGenTable(List<GenTable> tableList) {
    String operName = LoginHelper.getUsername();
    try {
        for (GenTable table : tableList) {
            String tableName = table.getTableName();
            // 初始化 表基础信息 并保存
            GenUtils.initTable(table, operName);
            int row = baseMapper.insert(table);
            // 初始化 该表的列信息 并保存
            if (row > 0) {
                List<GenTableColumn> genTableColumns = genTableColumnMapper.selectDbTableColumnsByName(tableName);
                List<GenTableColumn> saveColumns = new ArrayList<>();
                for (GenTableColumn column : genTableColumns) {
                    GenUtils.initColumnField(column, table);
                    saveColumns.add(column);
                }
                if (CollUtil.isNotEmpty(saveColumns)) {
                    genTableColumnMapper.insertBatch(saveColumns);
                }
            }
        }
    } catch (Exception e) {
        throw new ServiceException("导入失败：" + e.getMessage());
    }
}
```

### 详细生成表

修改时需要单表的相关详细数据

**获取库表基础信息 GenController#getInfo()**

```java
@SaCheckPermission("tool:gen:query")
@GetMapping(value = "/{tableId}")
public R<Map<String, Object>> getInfo(@PathVariable Long tableId) {
    GenTable table = genTableService.selectGenTableById(tableId);
    List<GenTable> tables = genTableService.selectGenTableAll();
    // 左查询 gen_column
    List<GenTableColumn> list = genTableService.selectGenTableColumnListByTableId(tableId);
    Map<String, Object> map = new HashMap<String, Object>();
    // 当前表详细
    map.put("info", table);
    // 当前表字段信息
    map.put("rows", list);
    // 所有表信息 , 关联表设置别用 (目前尚未开放可以无视)
    map.put("tables", tables);
    return R.ok(map);
}
```

### 修改生成表

**修改表信息接口 GenController#editSave()**

```java
@SaCheckPermission("tool:gen:edit")
@Log(title = "代码生成", businessType = BusinessType.UPDATE)
@PutMapping
public R<Void> editSave(@Validated @RequestBody GenTable genTable) {
    // 校验数据
    genTableService.validateEdit(genTable);
    genTableService.updateGenTable(genTable);
    return R.ok();
}
```

**修改实现 GenTableServiceImpl#updateGenTable()**

```java {7,11}
@Transactional(rollbackFor = Exception.class)
@Override
public void updateGenTable(GenTable genTable) {
    String options = JsonUtils.toJsonString(genTable.getParams());
    genTable.setOptions(options);
    // 保存修改表信息
    int row = baseMapper.updateById(genTable);
    // 保存修改列信息
    if (row > 0) {
        for (GenTableColumn cenTableColumn : genTable.getColumns()) {
            genTableColumnMapper.updateById(cenTableColumn);
        }
    }
}
```

### 生成预览

**预览接口 GenController#preview()**

```java
@SaCheckPermission("tool:gen:preview")
@GetMapping("/preview/{tableId}")
public R<Map<String, String>> preview(@PathVariable("tableId") Long tableId) throws IOException {
    Map<String, String> dataMap = genTableService.previewCode(tableId);
    return R.ok(dataMap);
}
```

**导出具体实现 GenTableServiceImpl#previewCode()**

```java
@Override
public Map<String, String> previewCode(Long tableId) {
    Map<String, String> dataMap = new LinkedHashMap<>();
    // 查询表信息
    GenTable table = baseMapper.selectGenTableById(tableId);
    List<Long> menuIds = new ArrayList<>();
    // 计算雪花id为生成SQL语句准备的
    for (int i = 0; i < 6; i++) {
        menuIds.add(identifierGenerator.nextId(null).longValue());
    }
    table.setMenuIds(menuIds);
    // 设置主子表信息 (在库获取设置)
    setSubTable(table);
    // 设置主键列信息
    setPkColumn(table);
    // 初始化 .vm解析
    VelocityInitializer.initVelocity();
    // 构建模板上下文(填充数据)
    VelocityContext context = VelocityUtils.prepareContext(table);

    // 获取模板列表
    List<String> templates = VelocityUtils.getTemplateList(table.getTplCategory());
    for (String template : templates) {
        // 渲染模板
        StringWriter sw = new StringWriter();
        Template tpl = Velocity.getTemplate(template, Constants.UTF8);
        tpl.merge(context, sw);
        dataMap.put(template, sw.toString());
    }
    return dataMap;
}
```

### 生成代码

生成方式有两种：

- 下载zip (推荐)
- 自定义路径生成

#### 下载zip

**zip下载接口 GenController#download()**

```java
@SaCheckPermission("tool:gen:code")
@Log(title = "代码生成", businessType = BusinessType.GENCODE)
@GetMapping("/download/{tableName}")
public void download(HttpServletResponse response, @PathVariable("tableName") String tableName) throws IOException {
    // 压缩包流
    byte[] data = genTableService.downloadCode(tableName);
    genCode(response, data);
}

// ... 

private void genCode(HttpServletResponse response, byte[] data) throws IOException {
    response.reset();
    response.addHeader("Access-Control-Allow-Origin", "*");
    response.addHeader("Access-Control-Expose-Headers", "Content-Disposition");
    response.setHeader("Content-Disposition", "attachment; filename=\"ruoyi.zip\"");
    response.addHeader("Content-Length", "" + data.length);
    response.setContentType("application/octet-stream; charset=UTF-8");
    IoUtil.write(response.getOutputStream(), false, data);
}
```

**业务下载接口 GenTableServiceImpl#downloadCode()**

```java
@Override
public byte[] downloadCode(String[] tableNames) {
    ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
    ZipOutputStream zip = new ZipOutputStream(outputStream);
    for (String tableName : tableNames) {
        generatorCode(tableName, zip);
    }
    IoUtil.close(zip);
    return outputStream.toByteArray();
}

// ...

// 和生成预览使用方式一样 , 该方法是将代码写入压缩流
private void generatorCode(String tableName, ZipOutputStream zip) {
    // 查询表信息
    GenTable table = baseMapper.selectGenTableByName(tableName);
    List<Long> menuIds = new ArrayList<>();
    for (int i = 0; i < 6; i++) {
        menuIds.add(identifierGenerator.nextId(null).longValue());
    }
    table.setMenuIds(menuIds);
    // 设置主子表信息
    setSubTable(table);
    // 设置主键列信息
    setPkColumn(table);
	// 初始化 .vm解析
    VelocityInitializer.initVelocity();
	// 构建模板上下文(填充数据)
    VelocityContext context = VelocityUtils.prepareContext(table);

    // 获取模板列表
    List<String> templates = VelocityUtils.getTemplateList(table.getTplCategory());
    for (String template : templates) {
        // 渲染模板
        StringWriter sw = new StringWriter();
        Template tpl = Velocity.getTemplate(template, Constants.UTF8);
        tpl.merge(context, sw);
        try {
            // 添加到zip
            zip.putNextEntry(new ZipEntry(VelocityUtils.getFileName(template, table)));
            IoUtil.write(zip, StandardCharsets.UTF_8, false, sw.toString());
            IoUtil.close(sw);
            zip.flush();
            zip.closeEntry();
        } catch (IOException e) {
            log.error("渲染模板失败，表名：" + table.getTableName(), e);
        }
    }
}
```

#### 自定义路径生成

**自定义路径 GenController#genCode()**

```java
@SaCheckPermission("tool:gen:code")
@Log(title = "代码生成", businessType = BusinessType.GENCODE)
@GetMapping("/genCode/{tableName}")
public R<Void> genCode(@PathVariable("tableName") String tableName) {
    genTableService.generatorCode(tableName);
    return R.ok();
}
```

**业务下载接口 GenTableServiceImpl#downloadCode()**

```java
@Override
public void generatorCode(String tableName) {
    // 查询表信息
    GenTable table = baseMapper.selectGenTableByName(tableName);
    // 设置主子表信息
    setSubTable(table);
    // 设置主键列信息
    setPkColumn(table);
    // 初始化 .vm解析
    VelocityInitializer.initVelocity();
    // 构建模板上下文(填充数据)
    VelocityContext context = VelocityUtils.prepareContext(table);

    // 获取模板列表
    List<String> templates = VelocityUtils.getTemplateList(table.getTplCategory());
    for (String template : templates) {
        // 排除前端相关代码
        if (!StringUtils.containsAny(template, "sql.vm", "api.js.vm", "index.vue.vm", "index-tree.vue.vm")) {
            // 渲染模板
            StringWriter sw = new StringWriter();
            Template tpl = Velocity.getTemplate(template, Constants.UTF8);
            tpl.merge(context, sw);
            try {
                // 获取自定义目录
                String path = getGenPath(table, template);
                // 写入自定义目录的文件中
                FileUtils.writeUtf8String(sw.toString(), path);
            } catch (Exception e) {
                throw new ServiceException("渲染模板失败，表名：" + table.getTableName());
            }
        }
    }
}

// ...

public static String getGenPath(GenTable table, String template) {
    String genPath = table.getGenPath();
    if (StringUtils.equals(genPath, "/")) {
        return System.getProperty("user.dir") + File.separator + "src" + File.separator + VelocityUtils.getFileName(template, table);
    }
    return genPath + File.separator + VelocityUtils.getFileName(template, table);
}
```

### 同步生成表

**同步接口 GenController#synchDb()**

```java
@SaCheckPermission("tool:gen:edit")
@Log(title = "代码生成", businessType = BusinessType.UPDATE)
@GetMapping("/synchDb/{tableName}")
public R<Void> synchDb(@PathVariable("tableName") String tableName) {
    genTableService.synchDb(tableName);
    return R.ok();
}
```

**业务实现 GenTableServiceImpl#synchDb()**

```java
public void synchDb(String tableName) {
    GenTable table = baseMapper.selectGenTableByName(tableName);
    List<GenTableColumn> tableColumns = table.getColumns();
    // Map转化 , key 为 column_name
    Map<String, GenTableColumn> tableColumnMap = StreamUtils.toIdentityMap(tableColumns, GenTableColumn::getColumnName);

    // 查库判断存在
    List<GenTableColumn> dbTableColumns = genTableColumnMapper.selectDbTableColumnsByName(tableName);
    if (CollUtil.isEmpty(dbTableColumns)) {
        throw new ServiceException("同步数据失败，原表结构不存在");
    }
    // 拿到表中的所有字段名
    List<String> dbTableColumnNames = StreamUtils.toList(dbTableColumns, GenTableColumn::getColumnName);

    List<GenTableColumn> saveColumns = new ArrayList<>();
    dbTableColumns.forEach(column -> {
        // 初始化字段
        GenUtils.initColumnField(column, table);
        // Map匹配存在字段 (保留原表信息操作)
        if (tableColumnMap.containsKey(column.getColumnName())) {
            GenTableColumn prevColumn = tableColumnMap.get(column.getColumnName());
            column.setColumnId(prevColumn.getColumnId());
            if (column.isList()) {
                // 如果是列表，继续保留查询方式/字典类型选项
                column.setDictType(prevColumn.getDictType());
                column.setQueryType(prevColumn.getQueryType());
            }
            // 如果列是必填且非忽略及父属性，并且在新增/修改中，且是非主键列，则保留之前的必填/显示类型选项
            if (StringUtils.isNotEmpty(prevColumn.getIsRequired()) && !column.isPk()
                && (column.isInsert() || column.isEdit())
                && ((column.isUsableColumn()) || (!column.isSuperColumn()))) {
                // 如果是(新增/修改&非主键/非忽略及父属性)，继续保留必填/显示类型选项
                column.setIsRequired(prevColumn.getIsRequired());
                column.setHtmlType(prevColumn.getHtmlType());
            }
        }
        saveColumns.add(column);
    });
    if (CollUtil.isNotEmpty(saveColumns)) {
        // 批量更新
        genTableColumnMapper.insertOrUpdateBatch(saveColumns);
    }
    // 删除多余的字段 (将新表不包含的字段进行删除)
    List<GenTableColumn> delColumns = StreamUtils.filter(tableColumns, column ->
        !dbTableColumnNames.contains(column.getColumnName()));
    if (CollUtil.isNotEmpty(delColumns)) {
        List<Long> ids = StreamUtils.toList(delColumns, GenTableColumn::getColumnId);
        genTableColumnMapper.deleteBatchIds(ids);
    }
}
```

## 相关文档

- [代码生成 - 模板详解](./02.代码生成-模板详解.md)
- [代码生成 - 配置示例](./03.代码生成-配置示例.md)