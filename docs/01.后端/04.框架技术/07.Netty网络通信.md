---
title: Nettyç½‘ç»œé€šä¿¡
author: æŸç«¹
permalink: /backend/6nss7s
date: 2023-03-16 00:00:00
categories: 
  - åç«¯
  - ç½‘ç»œ
  - Java
tags: 
  - Netty
  - ç½‘ç»œé€šä¿¡
---

## æ¦‚è¿°

Nettyæ˜¯ NIOå®¢æˆ·ç«¯æœåŠ¡å™¨è¿æ¥çš„æ¡†æ¶ , èƒ½å¤Ÿè¿›è¡Œç®€å•å¼€å‘ç½‘ç»œé€šä¿¡åº”ç”¨ç¨‹åº , åªè¦æœ‰ æœåŠ¡å™¨ è¿æ¥è‡³ å®¢æˆ·ç«¯ å°±å¯ç§°ä¹‹ä¸º IO é€šä¿¡  , 

Nettyæµ‹è¯•éœ€è¦JDKç‰ˆæœ¬ 1.8ä»¥ä¸Š

**Javaä¸­IOç¨‹åºåˆ†ç±» :** 

- [BIO](#BIO) (ä¸å»ºè®®)
- [NIO](#NIO) 

---

å®˜æ–¹API : [https://netty.io/4.1/api/index.html](https://netty.io/4.1/api/index.html)

Bç«™è§†é¢‘ : [https://www.bilibili.com/...](https://www.bilibili.com/video/BV1gd4y187V2/?p=1&share_source=copy_web&vd_source=64dacad77d0b983613675f662d5967b2) 

ç¬¬ä¸‰æ–¹æ–‡æ¡£ : https://www.w3cschool.cn/netty_4_user_guide/sw1v6ozt.html

## å…¥é—¨åº”ç”¨

### BIO

é‡‡ç”¨JavaSEåº“ä¸­çš„ `Socket`ç±» (å¥—æ¥å­—) , äº†è§£å¯ä»¥çœ‹ä¼šæˆ‘ä»¥å‰ç¬”è®° [ç‚¹å‡»è·³è½¬](/backend/pwb68r/#TCPç¨‹åºè®¾è®¡) 

**ç®€å•åº”ç”¨**

é€šè¿‡ Java è¿è¡Œçš„æœåŠ¡ç«¯ å’Œ cmd telnetæŒ‡ä»¤ é€šä¿¡

<img src="https://image.bozhu12.cc/myblog/Netty/Netty01.png" alt="Netty01" style="zoom: 33%;" /> 

1. JavaæœåŠ¡ç«¯ä»£ç 
   ::: details å±•å¼€ SocketServerç±» 

   ```java {9}
   public class SocketServer {
   
       public static void main(String[] args) throws IOException {
           // ç›‘å¬æœ¬æœºç«¯å£
           ServerSocket serverSocket = new ServerSocket(9099);
           while (true) {
               // é˜»å¡ç­‰å¾… å®¢æˆ·ç«¯ è¿æ¥
               System.out.println("ç­‰å¾…è¿æ¥...");
               Socket clientSocket = serverSocket.accept();
               System.out.println("æœ‰å®¢æˆ·è¿æ¥äº†...");
               handler(clientSocket);
           }
       }
   
       /**
        * æ¥æ”¶æ¶ˆæ¯
        * @param clientSocket å®¢æˆ·å¥—æ¥å­—
        */
       private static void handler(Socket clientSocket) throws IOException {
           byte[] bs = new byte[1024];
           int read = clientSocket.getInputStream().read(bs);
           System.out.println("read å®Œæˆ..");
           if (read != 1) {
               System.out.println("æ”¶åˆ°æ•°æ®: " + new String(bs, 0, read));
           }
       }
   
   }
   ```

   :::

2. cmd è¿›å…¥ , æ‰§è¡Œ telentå‘½ä»¤
   ```sh
   # è¿æ¥ æœ¬æœº:9099
   telent localhost 9099 
   # æ›´æ”¹æ¨¡å¼ Ctrl+] 
   send {å†…å®¹}
   # å…³é—­è¿æ¥ 
   quit
   ```

   > cmdé£Ÿç”¨ telentå‘½ä»¤ , éœ€è¦å¯åŠ¨WindowsåŠŸèƒ½
   >
   > æ§åˆ¶é¢æ¿ -> ç¨‹åº -> WindowsåŠŸèƒ½ -> å¯åŠ¨Telnet

3. æ–­ç‚¹æµ‹è¯•è§‚å¯Ÿ ä»£ç å—é«˜äº®é˜»å¡ç‚¹

é€šè¿‡ä¸Šé¢çš„æµ‹è¯• , å¯ä»¥å¾—çŸ¥BIOæœºåˆ¶æ˜¯ é˜»å¡ç­‰å¾… æ¶ˆæ¯ , å¯ä»¥çœ‹å‡ºä¸èƒ½å¤šå®¢æˆ·ç«¯è¿æ¥ . 

BIOä¸èƒ½åŒä¸€æ—¶é—´å¤„ç†å¤§é‡è¿æ¥çš„æ•°æ® , å³ä½¿å¤šçº¿ç¨‹ä¹Ÿæ‹›æ¶ä¸ä½ç™¾ä¸‡ç”¨æˆ·(å†…å­˜çˆ†ç‚¸) , å› æ­¤ä¸å»ºè®®ä½¿ç”¨ . å› æ­¤BIOå‘Šä¸€æ®µè½...

### NIO

NIOæ˜¯Nettyä¸»æµä½¿ç”¨çš„é€šä¿¡æ–¹å¼ , åœ¨ç®€å•åº”ç”¨ä¸­ NIOå’ŒBIOä½¿ç”¨çš„æ–¹å¼ç›¸å·®ä¸å¤§ , ä½†å®ƒä»¬çš„APIä¸åŒ

**ç®€å•åº”ç”¨**

é€šè¿‡ Java è¿è¡Œçš„æœåŠ¡ç«¯ å’Œ cmd telnetæŒ‡ä»¤ é€šä¿¡

1. JavaæœåŠ¡ç«¯ä»£ç 
   ::: details å±•å¼€ SocketServerç±»

   ```java {14}
   public class SocketServer {
   
       /**
        * ä¿å­˜å®¢æˆ·ç«¯è¿æ¥
        */
       static List<SocketChannel> channelList=  new ArrayList<>();
   
       public static void main(String[] args) throws IOException {
           // åˆ›å»ºNIO (å’ŒBIO ServerSocketç±»ä¼¼
           ServerSocketChannel serverSocket = ServerSocketChannel.open();
           // è®©å®¢æˆ·ç«¯ç»‘å®šç«¯å£
           serverSocket.socket().bind(new InetSocketAddress(9099));
           // è®¾ç½® éé˜»å¡
           serverSocket.configureBlocking(false);
           System.out.println("æœåŠ¡å™¨ å¯åŠ¨...");
   
           while (true) {
               // acceptæ–¹æ³• ä¸ä¼šé˜»å¡(è®¾ç½®äº†false
               SocketChannel socketChannel = serverSocket.accept();
               // æœªè¿æ¥null ä¸€è‡´å¤„äºå¾ªç¯çŠ¶æ€
               if (socketChannel != null) {
                   System.out.println("è¿æ¥æˆåŠŸ");
                   // è®¾ç½® SocketChannel ä¸ºéé˜»å¡
                   socketChannel.configureBlocking(false);
                   // ä¿å­˜å®¢æˆ·ç«¯è¿æ¥List
                   channelList.add(socketChannel);
               }
               // éå†è¿æ¥ è¿›è¡Œè¯»å–æ•°æ®
               Iterator<SocketChannel> iterator = channelList.iterator();
               while (iterator.hasNext()) {
                   SocketChannel next = iterator.next();
                   // å­—èŠ‚ç¼“å­˜åŒº
                   ByteBuffer byteBuffer = ByteBuffer.allocate(6);
                   // readæ–¹æ³• ä¸ä¼šé˜»å¡
                   int len = next.read(byteBuffer);
                   if (len > 0) {
                       System.out.println("æ”¶åˆ°æ¶ˆæ¯: "+new String(byteBuffer.array()));
                   }
                   if (len == -1) {
                       iterator.remove();
                       System.out.println("å®¢æˆ·ç«¯æ–­å¼€è¿æ¥");
                   }
               }
   
           }
   
       }
   }
   ```

   :::

2. æ‰“å¼€å¤šä¸ªcmd è¿æ¥ , æ”¯æŒä¸€ä¸ªä¿¡é“å¤šä¸ªè¿æ¥

   ```sh
   # è¿æ¥ æœ¬æœº:9099
   telent localhost 9099 
   # æ›´æ”¹æ¨¡å¼ Ctrl+] 
   send {å†…å®¹}
   # å…³é—­è¿æ¥ 
   quit
   ```

åœ¨ç®€å•åº”ç”¨æ–¹å¼ä¸­ NIOç½‘ç»œé€šä¿¡è™½ç„¶è§£å†³äº†é˜»å¡é—®é¢˜ , ä½†æ˜¯å¦‚æœå¤§é‡ç”¨æˆ·è¿æ¥ , ä½†çœŸæ­£é€šè®¯çš„åªæœ‰é‚£ä¹ˆå‡ ä¸ª , éå†çš„æ—¶ , å¤§å¤šéƒ½æ˜¯æ— æ•ˆéå† , ä¹Ÿå°±æ„å‘³ç€ä¼šé€ æˆæµªè´¹å†…å­˜ ! 

#### æ™®é€šNIOé€šä¿¡é—®é¢˜è§£å†³æ–¹æ¡ˆ

**æ€è·¯ :** ç”¨ä¸€ä¸ªå¤§å‹é›†åˆå­˜å‚¨ channelList å’Œ å°é›†åˆå­˜ è§¦å‘æ”¶å‘æ•°æ®çš„ channel , å¾ªç¯éå† å°é›†åˆå¤„ç†

`Selector`ç±» ç›‘å¬é€šä¿¡äº‹ä»¶ , ä¸€æ—¦æœ‰å¯¹è±¡è¿›è¡Œæ³¨å†Œ , ç›‘å¬å™¨åˆ™ä¼šç›‘å¬å¯¹è±¡äº‹ä»¶ , å®¢æˆ· è¿æ¥/å‘æ•°æ® , éƒ½ä¼šè§¦å‘äº‹ä»¶ , è¾¾åˆ°æœ‰äº‹å°±å¹²çš„ç›®çš„

**å…³é”®æ–¹æ³• :** 

| è¿”å›                         | æ–¹æ³•                            | è¯´æ˜                                             |
| ---------------------------- | ------------------------------- | ------------------------------------------------ |
| Selector                     | static open()                   | åˆ›å»º[epoll](#epoll æ¨¡å‹)                         |
| SelectionKey(é€šé“ä¸æ³¨å†Œçš„é”®) | register(Selector sel, int ops) | æ³¨å†Œ ServerSocketChannel , æŒ‡å®šopsç›‘å¬äº‹ä»¶       |
| int(å°±ç»ªæ“ä½œé›†çš„é”®æ•°)        | select()                        | ç­‰å¾…é˜»å¡ , å½“ç›‘å¬åˆ°å¯¹è±¡è§¦å‘äº†äº‹ä»¶ , æ‰ä¼šé‡Šæ”¾é€šè¡Œ |

> `Selector`åŸºäºepollå®ç° , ä»–ä»¬æ˜¯é€šè¿‡Linuxå†…æ ¸è¿›è¡Œæ“ä½œ , [ç‚¹å‡»äº†è§£ epoll](#epoll æ¨¡å‹)  

**äº‹ä»¶åˆ†ç±» :** 

| å¸¸é‡å                   | å€¼(int) | äº‹ä»¶è¯´æ˜ |
| ------------------------ | ------- | -------- |
| `Selectonkey.OPREAD`     | 1 << 0  | è¯»å–æ“ä½œ |
| `Selectonkey.OP_WRITE`   | 1 << 2  | å†™æ“ä½œ   |
| `Selectonkey.OP_CONNECT` | 1 << 3  | è¿æ¥æ“ä½œ |
| `Selectonkey.OP_ACCEPT`  | 1 << 4  | æ¥æ”¶æ“ä½œ |

::: tip
äº‹å®ä¸Šäº‹ä»¶éƒ½å­˜åˆ° `Selector.channels`å±æ€§ é›†åˆä¸­ , å¯é€šè¿‡ `selectedKeys()`æ–¹æ³• è·å–è§¦å‘äº‹ä»¶çš„é›†åˆ
:::

<img src="https://image.bozhu12.cc/myblog/Netty/Netty02.png" alt="Netty02" style="zoom:67%;" />  

å°±ç»ªäº‹ä»¶åˆ—è¡¨ `rdlist` , å¦‚æœ `channel` æœ‰äº‹ä»¶å‘ç”Ÿäº† , ä¼šå°†æ•°æ®æ”¾ç½® `rdlist` å°±ç»ªäº‹ä»¶åˆ—è¡¨ , è€Œ `epoll-wait` ä¼šç›‘å¬ `rdlist` åˆ—è¡¨

> æœ‰äº›å…³é”®ä¿¡æ¯æ˜¯æ¶‰åŠåˆ° [epoll](#epoll æ¨¡å‹) 

**ä»£ç æµ‹è¯• :** 

**å®¢æˆ·ç«¯**

::: details å±•å¼€ NioSelectorServerç±»

```java {11-13,18,21,24-49}
public class NioSelectorServer {

    public static void main(String[] args) throws IOException {

        // åˆ›å»ºNIO
        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();
        serverSocketChannel.socket().bind(new InetSocketAddress(9099));
        // serverSocketChannel è®¾ç½® éé˜»å¡
        serverSocketChannel.configureBlocking(false);
        // æ‰“å¼€ Selectorå¤„ç†Channel, å³åˆ›å»ºepoll
        Selector selector = Selector.open();
        // æŠŠ ServerSocketChannel æ³¨å†Œåˆ° selector ä¸Š , å¹¶ä¸”selectorå¯¹å®¢æˆ·ç«¯acceptè¿æ¥æ“ä½œ
        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);
        System.out.println("æœåŠ¡ç«¯å¯åŠ¨å®Œæˆ...");

        while (true) {
            // é˜»å¡ç­‰ç­‰å¾…æ—¶é—´å‘ç”Ÿ
            selector.select();

            // è·å– selectorä¸­æ³¨å†Œçš„å…¨éƒ¨äº‹ä»¶çš„ SelectionKeyå®ä¾‹
            Set<SelectionKey> selectionKeys = selector.selectedKeys();
            Iterator<SelectionKey> iterator = selectionKeys.iterator();

            while (iterator.hasNext()) {
                SelectionKey key = iterator.next();
                // å¦‚æœæ˜¯OP_ACCEPTäº‹ä»¶ , åˆ™è¿›è¡Œ è¿æ¥è·å– å’Œ äº‹ä»¶æ³¨å†Œ
                if (key.isAcceptable()) {
                    ServerSocketChannel server = (ServerSocketChannel) key.channel();
                    SocketChannel socketChannel = server.accept();
                    socketChannel.configureBlocking(false);
                    // è¿™é‡Œåªæ³¨å†Œè¯»äº‹ä»¶ , å¦‚æœéœ€è¦ç»™å®¢æˆ·ç«¯å‘é€æ•°æ®å¯ä»¥æ³¨å†Œå†™äº‹ä»¶
                    socketChannel.register(selector, SelectionKey.OP_READ);
                    System.out.println("å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ");
                }
                // å¦‚æœæ˜¯OP_READäº‹ä»¶ , åˆ™è¿›è¡Œ è¯»å–å’Œæ‰“å°
                if (key.isReadable()) {
                    SocketChannel socketChannel = (SocketChannel) key.channel();
                    ByteBuffer byteBuffer = ByteBuffer.allocate(6);
                    int len = socketChannel.read(byteBuffer);
                    if (len > 0) {
                        System.out.println("æ”¶åˆ°æ¶ˆæ¯: "+new String(byteBuffer.array()));
                    }else if (len == -1) {
                        iterator.remove();
                        System.out.println("å®¢æˆ·ç«¯æ–­å¼€è¿æ¥");
                    }
                }
                // åˆ é™¤å¤„ç†åçš„äº‹ä»¶(ä»¥é˜²ä¸‹æ¬¡å¤ç”¨)
                iterator.remove();
            }

        }

    }

}
```

:::

æ¨¡æ‹ŸæŸä¸€æ—¶é—´åˆ»å¤šç”¨æˆ·å‘é€æ¶ˆæ¯çš„æ–¹å¼ , æˆ‘ä»¬è§‚å¯Ÿ `selectedKeys`æ•°é‡(äº‹ä»¶æ•°)

1. æ–­ç‚¹è¿è¡Œ æœåŠ¡ç«¯ 
2. å¯åŠ¨ä¸€ä¸ªtelnet å¹¶è¿æ¥ , è§‚å¯Ÿæ–­ç‚¹æ³¨å†Œè¿‡ç¨‹ (selectedKeys: 1)
3. å¯åŠ¨ä¸¤ä¸ªtelnet å¹¶è¿æ¥ , è·³è¿‡æ–­ç‚¹æ³¨å†Œäº‹ä»¶è¿‡ç¨‹
4. æ‰“æ–­ç‚¹å‘é€æ¶ˆæ¯ , 3ä¸ªå®¢æˆ·ç«¯å„å‘é€2æ¡æ¶ˆæ¯ (selectedKeys: 6)
5. æœ€å selectedKeysè¿­ä»£éå†åªæ‰§è¡Œäº†6æ¬¡

::: note

é€šè¿‡ä»¥ä¸Šæµ‹è¯•æ¨¡æ‹Ÿå¯ä»¥å¾—çŸ¥ , `Selector`å¯¹è±¡ é€šè¿‡ç›‘å¬äº‹ä»¶è¡Œäº‹ , ä¸ä¼šå¹²æ— ç”¨åŠŸ(èŠ‚çœCPU) , ä¹ŸèŠ‚çœäº†ç©ºé—´(èŠ‚çœå†…å­˜) . æ­£å¥½è§£å†³äº†å‰é¢çš„é—®é¢˜(æ— æ•ˆå¾ªç¯)

:::

## epoll æ¨¡å‹

epoll åº•å±‚æ˜¯é€šè¿‡Cè¯­è¨€è¿è¡Œçš„ , å› æ­¤ éœ€è¦ JavaAPI `Selector`ç±» è¿›è¡Œæ“ä½œ , é€šè¿‡ `Selector` ç›´æ¥æ§åˆ¶ Linuxå†…æ ¸æ“ä½œ

`Selector`ç±»ä¸­çš„ å…³é”®æ–¹æ³• ä¸ epollåº•å±‚ å…³é”®å‡½æ•° ç›¸å¯¹åº”

| Selector   | epoll          |
| ---------- | -------------- |
| open()     | epoll_create() |
| register() | epoll_ctl()    |
| select()   | epoll_wait()   |

epollåº•å±‚ä¸­çš„ å…³é”®å‡½æ•° : 

- `epoll_create()` : å®ä¾‹åŒ–
- `epoll_ctl()` : (æ³¨å†Œ) ä½¿ç”¨ æ–‡ä»¶æ‰«æç¬¦ epfd å¼•ç”¨ epollå®ä¾‹ , å¯¹ç›®æ ‡æ–‡ä»¶opæ“ä½œ
- `epoll_wait()` : (ç­‰äº‹ä»¶) ç­‰å¾… æ–‡ä»¶æè¿°ç¬¦ epfdäº‹ä»¶

åˆ†åˆ«è§£åˆ¨ä»–ä»¬çš„å…³é”®æ–¹æ³•å¯¹åº”çš„Linuxå†…æ ¸å‡½æ•° (ä¸‹å›¾ä»…äº†è§£)

![](https://image.bozhu12.cc/myblog/Netty/Netty03.png)

## Nattyåº”ç”¨

ä¸Šé¢ [NIO](#NIO) åº”ç”¨ , æ˜¾ç„¶æ²¡æœ‰å‘æŒ¥åˆ°æè‡´ .

å‡è®¾æˆ‘ä»¬æ­£åœ¨æ‰“å¤§å‹æ¸¸æˆ , ä¸æœåŠ¡å™¨é€šä¿¡ , æ¯æ¬¡IOäº¤äº’éƒ½ä¼šä¸Šä¸‡äº‹ä»¶ . å¾ˆéš¾ç°è±¡ä»…é ä¸€ä¸ªå¾ªç¯è§£å†³è¿™äº›äº‹ä»¶å¹¶éæ˜¯ä¼˜åŒ–çš„è§£å†³æ–¹æ¡ˆ , é‚£ä¹ˆäº‹ä»¶ä¸€æ—¦å¤šäº†å°±ä¼šå¡(é«˜pingæˆ˜å£«) . åœ¨é€šä¿¡æ¡†æ¶çš„æŠ€æœ¯é€‰å‹è¿˜æ˜¯æœ‰å¿…è¦æ³¨é‡ä¸‹çš„! (å“ªæ€•æ˜¯å¤šçº¿ç¨‹ä¹Ÿéš¾ä»¥é©¾é©­)

å› æ­¤Nettyå¯¹NIOå¤„ç†åšäº†å¤§é‡ä¼˜åŒ– , å› æ­¤æˆ‘ä»¬å…³æ³¨çš„æ“ä½œ , åªéœ€3æ­¥ :

1. åˆå§‹åŒ–åˆ›å»ºå¯åŠ¨å¯¹è±¡ `new ServerBootstrap`
2. é“¾å¼é…ç½®å¯åŠ¨å¯¹è±¡
3. å¯åŠ¨NettyæœåŠ¡ç«¯

**Nettyå†…éƒ¨æ“ä½œ**

é€šè¿‡ Reactor å®ç°æ“ä½œ(å“åº”å¼ç¼–ç¨‹) , Reactor ç±»ä¼¼äº Selector 

**æ€è·¯ :** (Neetyä¼˜åŒ–å¤§è‡´æ€è·¯)

mainReactor ä¸“é—¨è´Ÿè´£è¿æ¥ , è¿æ¥å¤„ç†å¥½äº¤ç»™ subReactor

subReactor ä¸“é—¨è´Ÿè´£åç«¯æ”¶å‘

::: tip

ä¸éš¾å‘ç° , åœ¨åˆ›å»ºæœåŠ¡ç«¯å¯¹è±¡çš„æ—¶å€™ , è¦æœ‰ä¸¤ä¸ªçº¿ç¨‹æ±  , æ˜¯ä¸“é—¨ä¸ºä»¥ä¸Šä¸¤ä¸ªReactorå¤„ç†ä½¿ç”¨çš„!

:::

### ä»£ç ç¤ºä¾‹

**å¤§è‡´æ­¥éª¤ :** 

1. å¼•å…¥ä¾èµ–
2. åˆ›å»ºå¯åŠ¨å¯¹è±¡ 
3. ç¼–å†™ äº‹ä»¶å¤„ç†ç±» , å¹¶ä¸”åœ¨å¯åŠ¨å¯¹è±¡è¿›è¡Œé…ç½®
4. å¯åŠ¨æœåŠ¡å™¨
5. cmd telnetè¿æ¥ æµ‹è¯•

**Nettyä¾èµ–** (ç‰ˆæœ¬è‡ªé€‰)

```xml
<!-- https://mvnrepository.com/artifact/io.netty/netty-all -->
<dependency>
    <groupId>io.netty</groupId>
    <artifactId>netty-all</artifactId>
    <version>4.1.87.Final</version>
</dependency>
```

**æœåŠ¡å™¨**

::: details å±•å¼€ NettyServerç±»

```java
public class NettyServer {

    public static void main(String[] args) {
        /**
         * åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„bossGroupå’ŒworkerGroup, å«æœ‰çš„å­çº¿ç¨‹NioEventLoopçš„ä¸ªæ•°è®¤ä¸ºcpuæ ¸æ•°çš„ä¸¤å€
         * - boosGroup å¤„ç†è¿æ¥è¯·æ±‚ (mainReactor
         * - workerGroup å¤„ç†ä¸šåŠ¡ (subReactor
         */
        EventLoopGroup boosGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup(10);

        try {
            // åˆ›å»º æœåŠ¡ç«¯å¯åŠ¨å¯¹è±¡
            ServerBootstrap bootstrap = new ServerBootstrap();
            // é“¾å¼é…ç½®å‚æ•°
            bootstrap.group(boosGroup, workerGroup)
                    // ä½¿ç”¨NioServerSocketChannelä½œä¸ºæœåŠ¡å™¨é€šé“å®ç°
                    .channel(NioServerSocketChannel.class)
                    // åˆå§‹åŒ–æœåŠ¡å™¨è¿æ¥é˜Ÿåˆ—å¤§å° , æœåŠ¡å™¨å¤„ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚é¡ºåºå¤„ç† , æ‰€ä»¥ åŒä¸€æ—¶é—´åªèƒ½å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥
                    // å¦‚å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥æ—¶ , è¯·æ±‚æ”¾ç½®é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†
                    .option(ChannelOption.SO_BACKLOG, 1024)
                    // è®¾ç½®å¤„ç†å™¨
                    .childHandler(new ChannelInitializer<SocketChannel>() {
                        @Override
                        protected void initChannel(SocketChannel socketChannel) throws Exception {
                            socketChannel.pipeline().addLast(new NettyServerHandler());
                        }
                    });
            System.out.println("netty server start...");
            // ç»‘å®šç«¯å£ , ç”Ÿæˆ ChannelFutureå¼‚æ­¥å¯¹è±¡ , é€šè¿‡isDone()
            // å¯åŠ¨æœåŠ¡å™¨bind() ; å¼‚æ­¥æ“ä½œsync()
            ChannelFuture cf = bootstrap.bind(9099).sync();

            // ç­‰å¾…æœåŠ¡å™¨ socket å…³é—­ ã€‚
            // åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¿™ä¸ä¼šå‘ç”Ÿï¼Œä½†ä½ å¯ä»¥ä¼˜é›…åœ°å…³é—­ä½ çš„æœåŠ¡å™¨ã€‚
            cf.channel().closeFuture().sync();

        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }

    }
    
}
```

:::

**æœåŠ¡ç«¯ äº‹ä»¶å¤„ç† **

::: details å±•å¼€ NettyServerHandlerç±»

```java
/**
 * è‡ªå®šä¹‰Handler ç»§æ‰¿Netty æŸä¸ª HandlerAdapter(è§„èŒƒ)
 *
 * å…¥ç«™äº‹ä»¶å¤„ç†
 */
public class NettyServerHandler extends ChannelInboundHandlerAdapter {

    /**
     * å½“å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨è§¦å‘æ–¹æ³•
     * @param ctx
     * @throws Exception
     */
    @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception {
        System.out.println("å®¢æˆ·ç«¯ é€šé“ å»ºç«‹å®Œæˆ...");
    }

    /**
     * è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
     * @param ctx
     * @param msg
     * @throws Exception
     */
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
        // ç±»ä¼¼NIO çš„ ByteBuffer
        ByteBuf buf = (ByteBuf) msg;
        System.out.println("æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯: "+buf.toString(StandardCharsets.UTF_8));
    }
}
```

:::

**æµ‹è¯•**

1. å¯åŠ¨ å®¢æˆ·ç«¯
2. cmd æ‰§è¡Œ telentå‘½ä»¤ 
3. éšæ„å‘é€æ¶ˆæ¯

::: tip

ä»¥ä¸Šä»£ç å¯ä»¥ä½œä¸ºæ¨¡æ¿åº”ç”¨ , å›  ä¸ç®¡æ€ä¹ˆç”¨éƒ½æ˜¯åŒä¸€è¿‡ç¨‹

:::

### èŠå¤©å®¤

åŸºäºNettyç®€å•å®ç°èŠå¤©å®¤ , æ¨¡æ‹Ÿ ç¾¤èŠåŠŸèƒ½ , ä»…é™åœ¨çº¿é€šä¿¡

**æœåŠ¡ç«¯**

::: details å±•å¼€ ChatServerç±»

```java
/**
 * æœåŠ¡ç«¯ èŠå¤©å®¤
 * ç›´æ¥å¥—ç”¨Nettyæ¨¡æ¿
 */
public class ChatServer {

    public static void main(String[] args) {
        EventLoopGroup boosGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup(10);

        try {
            ServerBootstrap bootstrap = new ServerBootstrap();
            bootstrap.group(boosGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .option(ChannelOption.SO_BACKLOG, 1024)
                    // è®¾ç½®å¤„ç†å™¨
                    .childHandler(new ChannelInitializer<SocketChannel>() {
                        @Override
                        protected void initChannel(SocketChannel socketChannel) throws Exception {
                            // åŠ å…¥ è§£ç å™¨
                            socketChannel.pipeline().addLast("decoder",new StringDecoder());
                            // åŠ å…¥ ç¼–ç å™¨
                            socketChannel.pipeline().addLast("encoder",new StringEncoder());
                            socketChannel.pipeline().addLast(new ChatServerHandler());
                        }
                    });
            System.out.println("èŠå¤©å®¤ server start...");
            ChannelFuture cf = bootstrap.bind(9099).sync();
            cf.channel().closeFuture().sync();
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
    }

}
```

:::

**å®¢æˆ·ç«¯**

::: details å±•å¼€ ChatClientç±»

```java
/**
 * èŠå¤©å®¤ å®¢æˆ·ç«¯
 */
public class ChatClient {

    public static void main(String[] args) {

        EventLoopGroup group = new NioEventLoopGroup();
        try {
            Bootstrap bootstrap = new Bootstrap();
            bootstrap.group(group)
                    .channel(NioSocketChannel.class)
                    .handler(new ChannelInitializer<Channel>() {
                        @Override
                        protected void initChannel(Channel channel) {
                            // åŠ å…¥ è§£ç å™¨
                            channel.pipeline().addLast("decoder", new StringDecoder());
                            // åŠ å…¥ ç¼–ç å™¨
                            channel.pipeline().addLast("encoder", new StringEncoder());
                            channel.pipeline().addLast(new ChatClientHandler());
                        }
                    });
            // è¿æ¥æœåŠ¡ç«¯
            ChannelFuture channelFuture = bootstrap.connect("127.0.0.1", 9099).sync();
            // è·å–ä¿¡é“ channel
            Channel channel = channelFuture.channel();
            System.out.println("============" + channel.localAddress() + "============");
            // æ‰«æå™¨ , å¯¹æ¥ä¿¡æ¯
            Scanner sc = new Scanner(System.in);
            while (sc.hasNextLine()) {
                String msg = sc.nextLine();
                // å‘æ¶ˆæ¯ (å‘åˆ°æœåŠ¡ç«¯), å¾€ä¿¡é“å†™æ•°æ®å¹¶åˆ·æ–°
                channel.writeAndFlush(msg);
            }

        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
    }

}
```

:::

**æœåŠ¡ç«¯äº‹ä»¶å¤„ç†**

::: details å±•å¼€ ChatServerHandlerç±»

```java
public class ChatServerHandler extends SimpleChannelInboundHandler {

    private static ChannelGroup channelGroup = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE);
    SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");

    /**
     * å°±ç»ªçŠ¶æ€ , æç¤ºä¸Šçº¿
     * @param ctx
     * @throws Exception
     */
    @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception {
        Channel channel = ctx.channel();
        // è¿œç«¯åœ°å€
        SocketAddress socketAddress = channel.remoteAddress();
        // æ¨é€æ¶ˆæ¯ (å…¬å‘Š)
        // è¯¥æ–¹æ³•å°† channelGroupä¸­çš„æ‰€æœ‰çš„ channeléå† , å¹¶å‘é€æ¶ˆæ¯
        channelGroup.writeAndFlush("[å®¢æˆ·ç«¯] " + socketAddress + " ä¸Šçº¿äº†" + sdf.format(new Date()) + "\n");
        // å°†å½“å‰å®¢æˆ·ç«¯ channel åŠ å…¥åˆ° channelGroup (åŠ å…¥ç»„)
        channelGroup.add(channel);
        System.out.println("ä¸Šçº¿ > "+socketAddress);
    }

    /**
     * ä¸æ´»åŠ¨çŠ¶æ€ , æç¤ºç¦»çº¿
     * @param ctx
     * @throws Exception
     */
    @Override
    public void channelInactive(ChannelHandlerContext ctx) throws Exception {
        Channel channel = ctx.channel();
        // è¿œç«¯åœ°å€
        SocketAddress socketAddress = channel.remoteAddress();
        // æ¨é€æ¶ˆæ¯ (å…¬å‘Š)
        // è¯¥æ–¹æ³•å°† channelGroupä¸­çš„æ‰€æœ‰çš„ channeléå† , å¹¶å‘é€æ¶ˆæ¯
        channelGroup.writeAndFlush("[å®¢æˆ·ç«¯] " + socketAddress + " ä¸‹çº¿äº†" + sdf.format(new Date()) + "\n");
        // å°†å½“å‰å®¢æˆ·ç«¯ channel åŠ å…¥åˆ° channelGroup (åŠ å…¥ç»„)
        System.out.println("ç¦»çº¿ > "+socketAddress);
        System.out.println("channelGroup Size: " + channelGroup.size());
    }

    /**
     * è¯»å–æ¶ˆæ¯
     * @param channelHandlerContext
     * @param o
     * @throws Exception
     */
    @Override
    protected void channelRead0(ChannelHandlerContext channelHandlerContext, Object o) throws Exception {
        // è·å–å½“å‰ channel (å‘é€è€…)
        Channel channel = channelHandlerContext.channel();
        String msg = o.toString().trim();
        channelGroup.forEach(ch -> {
            if (channel != ch) {
                ch.writeAndFlush("[å®¢æˆ·ç«¯] " + channel.remoteAddress() + " å‘é€äº†æ¶ˆæ¯: " + msg + "\n");
            } else {
                ch.writeAndFlush("[è‡ªå·±] å‘é€äº†æ¶ˆæ¯: " + msg + "\n");
            }
        });
        System.out.println();
    }

    /**
     * å¼‚å¸¸å¤„ç†
     * @param ctx
     * @param cause
     * @throws Exception
     */
    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
        // å…³é—­ä¿¡é“
        ctx.close();
    }
}
```

:::

**å®¢æˆ·ç«¯äº‹ä»¶å¤„ç†**

::: details å±•å¼€ ChatClientHandlerç±»

```java
public class ChatClientHandler extends SimpleChannelInboundHandler {

    @Override
    protected void channelRead0(ChannelHandlerContext channelHandlerContext, Object o) throws Exception {
        System.out.println(o.toString().trim());
    }
}
```

:::

**æµ‹è¯•**

1. å¯åŠ¨ 1ä¸ªæœåŠ¡ç«¯
2. å¯åŠ¨ 3ä¸ªå®¢æˆ·ç«¯
3. è§‚å¯Ÿ ä¸Šçº¿æç¤º
4. 3ä¸ªå®¢æˆ·ç«¯ åˆ†åˆ«å‘é€äº›æ¶ˆæ¯
5. è§‚å¯Ÿ å®¢æˆ·ç«¯æ˜¯å¦å‡æ”¶åˆ°æ¶ˆæ¯
6. ç¦»çº¿ 2ä¸ªå®¢æˆ·ç«¯
7. è§‚å¯Ÿ ç¦»çº¿æ•°é‡

::: tip

èŠå¤©ç³»ç»Ÿæ˜¯ä¸æ˜¯å¾ˆç®€å• , æœ‰æ‰‹å°±è¡Œ , å¯¹å§ (æ‰æ€ª , åˆšæ¥è§¦æˆ‘ä¹Ÿæ˜¯æŠ„çš„ ğŸ˜‹)

:::

## æµ·é‡æ•°æ®æ¶æ„å›¾

### 1.0ç‰ˆæœ¬

![](https://image.bozhu12.cc/myblog/Netty/Netty04.png)

**Q&A**

**Q :** å¦‚æœClient-1 å‘æ¶ˆæ¯ç»™ Client-2 , ä¸”ä»–ä»¬ä¸åœ¨åŒä¸€NettyæœåŠ¡å™¨ä¸Š , å¦‚ä½•è¿›è¡Œé€šä¿¡?

**A :** å½“Client-1å‘æ¶ˆæ¯æ—¶ , åœ¨ç½‘å…³å±‚ä¼šåˆ¤æ–­Client-1å’ŒClient-2æ˜¯å¦åœ¨åŒä¸€NettyæœåŠ¡å™¨ , ä¸åœ¨åŒä¸€æœåŠ¡å™¨ä¼šåœ¨ReidsæŸ¥ Client-2 æ‰€è¿æ¥çš„NettyæœåŠ¡å™¨ , å¯åœ¨ç½‘å…³å±‚è¿›è¡Œè½¬å‘åˆ° Client-2 è¿æ¥çš„NettyæœåŠ¡å™¨ , è¾¾åˆ°é€šä¿¡ç›®çš„!

### 2.0ç‰ˆæœ¬

<img src="https://image.bozhu12.cc/myblog/Netty/Netty05.png" style="zoom:67%;" /> 

**2.0 å’Œ 1.0 çš„åŒºåˆ«** (è·ç¦»å¤§å‚è¿›äº†ä¸€å¤§æˆª)

1. æ•°æ®åº“å­˜å‚¨ æ¶ˆæ¯
2. RabbitMQæ¶ˆæ¯é˜Ÿåˆ—ç¼“å­˜æ¶ˆé”‹
3. å¾®æœåŠ¡æ¶æ„
4. æ”¯æŒç¦»çº¿å‘é€

**Q&A**

**Q :** å¦‚æœClient-1 å‘æ¶ˆæ¯ç»™ Client-2 , ä½†Client-2ä¸åœ¨çº¿ , å¦‚ä½•è¿›è¡Œæ¨é€åˆ°ç›®çš„?

**A :** å½“Client-1å‘æ¶ˆæ¯å , åœ¨ç½‘å…³å±‚åˆ¤æ–­Client-2æ˜¯å¦å­˜åœ¨ , å¦‚æœä¸åœ¨çº¿ä¼šå°†ä¿¡æ¯ç¼“å­˜åˆ°Redisç›´åˆ°Reidsä¸Šçº¿æ‹‰å»å®Œæˆå , æ‰ä¼šåœ¨ç¼“å­˜æ¸…é™¤è¯¥æ¶ˆæ¯ ! 

---

ä»¥ä¸Šä¿¡æ¯ä»…ä»…æ˜¯äº†è§£ Nettyç½‘ç»œé€šä¿¡ , å¹¶éæ·±å…¥å­¦ä¹ !

